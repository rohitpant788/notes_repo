## **🔥 Introduction**

- **Spring Data JPA** allows defining **relationships** between multiple entities in a relational database.
- In a **real-world scenario**, relationships exist between different entities:
    - A **college** has multiple **classrooms**.
    - A **professor** teaches multiple **students**.
    - A **student** takes multiple **courses**.
    - A **course** is taken by multiple **students**.
- These relationships are implemented using **Spring Data JPA mappings**.

---

## **🛠️ Types of Relationships in Spring Data JPA**

Spring Data JPA supports **four types of mappings**:

1️⃣ **One-to-One (**`**@OneToOne**`**)**

- Example: **A department has one manager.**
- Each **department** must have a **manager**.
- An **employee** can either be a **manager** or a regular employee.
- Each department can have only one manager.

2️⃣ **One-to-Many (**`**@OneToMany**`**)**

- Example: **A department has multiple employees.**
- A **single department** can have **multiple employees**, but an **employee** belongs to **one department**.

3️⃣ **Many-to-One (**`**@ManyToOne**`**)**

- Example: **Each employee belongs to one department, but one department can have many employees.**
- It is the reverse of **One-to-Many mapping**.

4️⃣ **Many-to-Many (**`**@ManyToMany**`**)**

- Example: **An employee can work on multiple projects, and a project can have multiple employees.**
- There is an **intermediate mapping table**.

---

## **📌 Understanding One-to-One Mapping (**`**@OneToOne**`**)**

- **One-to-One mapping** establishes a direct **association between two entities**.
- Example: **Each department has exactly one manager.**
- The **foreign key** is stored inside **one entity**.

### **🛠️ Steps to Define One-to-One Mapping**

1. **Create Entities** (`Department` and `Employee`).
2. **Use** `**@OneToOne**` **Annotation** to establish the relationship.
3. **Use** `**@JoinColumn**` **to specify the foreign key.**
4. **Configure** `**fetch**` **and** `**cascade**` **properties.**

---

## **📌 Creating Entities in Spring Data JPA**

### **📝 Department Entity**

```Java
@Entity
public class Department {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private String title;

    @OneToOne
    @JoinColumn(name = "department_manager", unique = true)
    private Employee manager;
}
```

✔ `**@OneToOne**` → Defines a one-to-one relationship.

✔ `**@JoinColumn(name = "department_manager")**` → Defines the foreign key column inside `Department`.

✔ `**unique = true**` → Ensures **each department has a unique manager**.

---

### **📝 Employee Entity**

```Java

@Entity
public class Employee {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private String name;

    @OneToOne(mappedBy = "manager")
    @JsonIgnore
    private Department managedDepartment;
}

```

✔ `**@OneToOne(mappedBy = "manager")**` → Indicates the **inverse side** of the relationship.

✔ `**@JsonIgnore**` → Prevents **infinite recursion** when serializing to JSON.

---

## **📌 Creating Database Tables**

### **Generated Tables in SQL**

- **Department Table (**`**departments**`**)**
    
    ```Plain
    bash
    CopyEdit
    | id | title  | department_manager |
    |----|--------|--------------------|
    | 1  | HR     | 1                  |
    | 2  | IT     | 2                  |
    
    ```
    
    ✔ The **department_manager** column is a **foreign key** referring to **employee ID**.
    
- **Employee Table (**`**employees**`**)**
    
    ```Plain
    pgsql
    CopyEdit
    | id | name |
    |----|------|
    | 1  | John |
    | 2  | Jane |
    
    ```
    
    ✔ **Employee does not store any foreign key**.
    

---

## **📌 Creating Repositories (**`**JpaRepository**`**)**

### **📝 Department Repository**

```Java
public interface DepartmentRepository extends JpaRepository<Department, Long> {
}
```

### **📝 Employee Repository**

```Java
public interface EmployeeRepository extends JpaRepository<Employee, Long> {
}
```

---

## **📌 Creating Services (**`**Service Layer**`**)**

### **📝 Assigning a Manager to a Department**

```Java
@Service
public class DepartmentService {

    private final DepartmentRepository departmentRepository;
    private final EmployeeRepository employeeRepository;

    @Autowired
    public DepartmentService(DepartmentRepository departmentRepository, EmployeeRepository employeeRepository) {
        this.departmentRepository = departmentRepository;
        this.employeeRepository = employeeRepository;
    }

    public Department assignManagerToDepartment(Long departmentId, Long employeeId) {
        Department department = departmentRepository.findById(departmentId)
                                  .orElseThrow(() -> new RuntimeException("Department not found"));

        Employee employee = employeeRepository.findById(employeeId)
                              .orElseThrow(() -> new RuntimeException("Employee not found"));

        department.setManager(employee);
        return departmentRepository.save(department);
    }
}
```

✔ **Finds the department & employee by ID.**

✔ **Assigns the employee as the department's manager.**

✔ **Saves the updated department to the database.**

---

## **📌 Creating Controllers (**`**RestController**`**)**

### **📝 Assign Manager to Department (PUT API)**

```Java
@RestController
@RequestMapping("/departments")
public class DepartmentController {

    private final DepartmentService departmentService;

    @Autowired
    public DepartmentController(DepartmentService departmentService) {
        this.departmentService = departmentService;
    }

    @PutMapping("/{departmentId}/manager/{employeeId}")
    public ResponseEntity<Department> assignManager(@PathVariable Long departmentId, @PathVariable Long employeeId) {
        Department updatedDepartment = departmentService.assignManagerToDepartment(departmentId, employeeId);
        return ResponseEntity.ok(updatedDepartment);
    }
}
```

✔ **PUT API:** `localhost:8080/departments/1/manager/2`

✔ **Updates the department with a new manager.**

---

## **📌 Handling Recursive Serialization**

**Problem: Infinite Recursion in JSON Response**

- If a department has a manager, and a manager has a department reference, **it causes an infinite loop** during serialization.

### **Solution: Use** `**@JsonIgnore**`

✔ Add `**@JsonIgnore**` to prevent serialization issues in Employee entity.

```Java
@OneToOne(mappedBy = "manager")
@JsonIgnore
private Department managedDepartment;
```

---

## **📌 Fetch Types in JPA**

**Determines when related entities are fetched from the database.**  
1️⃣ **EAGER (Default for** `**@OneToOne**`**)**

- **Loads related entities immediately** when querying the parent entity.
- **Downside**: Unnecessary joins in queries (performance issues).

2️⃣ **LAZY (**`**fetch = FetchType.LAZY**`**)**

- **Loads related entities only when accessed**.
- **Recommended for large datasets** to improve performance.

✔ **Example: Lazy Fetch Type**

```Java
@OneToOne(fetch = FetchType.LAZY)
private Employee manager;
```

---

## **📌 Cascading Operations in JPA**

- Defines how operations (persist, merge, remove) **propagate** from one entity to another.

✔ **Example: CascadeType.ALL**

```Java
@OneToOne(cascade = CascadeType.ALL)
private Employee manager;
```

- **CascadeType.ALL** → Any operation on **Department** also affects **Employee**.

---

## **🔹 Summary (Quick Revision)**

✅ **One-to-One Mapping (**`**@OneToOne**`**)** allows **direct relationships** between two entities.

✅ **Foreign key (**`**@JoinColumn**`**)** is placed in the **owning entity**.

✅ **Unidirectional Mapping** → Only one entity knows about the relationship.

✅ **Bidirectional Mapping** → Both entities reference each other using `mappedBy`.

✅ **Handling Recursive Serialization** → Use `@JsonIgnore` to avoid infinite loops.

✅ **Fetching Strategies** → **Eager (default)** loads immediately, **Lazy** loads on demand.

✅ **Cascade Operations** → Define how changes in one entity affect the related entity.

---

### **💡 GIT Repo**

- [https://github.com/rohitpant788/learning_java_full_stack/blob/main/week_3.5/dataMappingTutorial/src/main/java/com/rohit/tutorial/dataMapping/dataMappingTutorial/entities/DepartmentEntity.java#L26](https://github.com/rohitpant788/learning_java_full_stack/blob/main/week_3.5/dataMappingTutorial/src/main/java/com/rohit/tutorial/dataMapping/dataMappingTutorial/entities/DepartmentEntity.java#L26)